version: "3.7"
services:
    db:
        image: postgres:11.12
        restart: always
        environment:
            POSTGRES_DB: postgres
            POSTGRES_USER: admin
            POSTGRES_PASSWORD: secret
            PGDATA: /var/lib/postgresql/data
        ports:
            - "5433:5433"
        command: -p 5433

    web:
        image: "django_amp:latest"
        command: >
            bash -c "
            sleep 5;
            psql postgres://admin:secret@db:5433/postgres -c \"create database accessibility_monitoring_app;\";
            python3 manage.py collectstatic --noinput;
            python3 manage.py migrate;
            echo \"from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser(\'admin@email.com\', \'admin@email.com\', \'secret\')\" | python3 manage.py shell;
            python3 manage.py recache_statuses;
            waitress-serve --port=8001 accessibility_monitoring_platform.wsgi:application;
            "
        ports:
            - "8001:8001"
        depends_on:
            - db
            - localstack
        environment:
            - PGPASSWORD=secret
            - VCAP_SERVICES={'aws-s3-bucket':[{'binding_guid':'00000000-0000-0000-0000-000000000000','credentials':{'aws_access_key_id':'key','aws_region':'us-east-1','aws_secret_access_key':'secret','bucket_name':'bucketname','deploy_env':''},'instance_guid':'00000000-0000-0000-0000-000000000000','instance_name':'instance_name','label':'aws-s3-bucket','name':'instance_name','plan':'default','tags':['s3'],'volume_mounts':[]}],'postgres':[{'credentials':{'uri':'postgres://admin:secret@db:5433/accessibility_monitoring_app'},'name':'monitoring-platform-default-db'}]}
            - ALLOWED_HOSTS='* localhost 0.0.0.0 0.0.0.0:8001'
            - SECRET_KEY='123456789'
            - DEBUG=TRUE
            - PORT='8001'
            - INTEGRATION_TEST=TRUE
            - PLATFORM_VERSION=0.2

    localstack:
        image: localstack/localstack
        hostname: localstack
        ports:
        - "4567:4566"
        - "4572:4571"
        environment:
        - SERVICES=s3
        - AWS_DEFAULT_REGION=us-east-1
        - HOSTNAME_EXTERNAL=localstack
        volumes:
        - "/var/run/docker.sock:/var/run/docker.sock"
