# Generated by Django 5.1.8 on 2025-04-24 14:53
import ast

from django.db import migrations

CHECK_RESULT_CONTENT_TYPE_ID: int = 51
RETEST_STATE_DEFAULT: str = "not-fixed"


def populate_retest_notes_history(apps, schema_editor):
    Event = apps.get_model("common", "Event")
    CheckResult = apps.get_model("audits", "CheckResult")
    CheckResultHistory = apps.get_model("audits", "CheckResultHistory")
    for event in (
        Event.objects.filter(content_type_id=CHECK_RESULT_CONTENT_TYPE_ID)
        .filter(type="model_update")
        .filter(value__contains="retest_notes")
        .order_by("created")
    ):
        value_dict: dict[str, str] = ast.literal_eval(event.value)
        if "retest_notes" in value_dict:
            _, retest_notes = value_dict["retest_notes"].split(" -> ")
        else:
            continue
        if "retest_state" in value_dict:
            _, retest_state = value_dict["retest_state"].split(" -> ")
        else:
            retest_state: str = RETEST_STATE_DEFAULT
        check_result = CheckResult.objects.get(id=event.object_id)
        check_result_history: CheckResultHistory = CheckResultHistory.objects.create(
            check_result=check_result,
            retest_state=retest_state,
            retest_notes=retest_notes,
            created_by=event.created_by,
        )
        check_result_history.created = event.created
        check_result_history.save()


def reverse_code(apps, schema_editor):  # pylint: disable=unused-argument
    pass


class Migration(migrations.Migration):

    dependencies = [
        ("audits", "0016_checkresulthistory"),
        ("common", "0001_initial"),
    ]

    operations = [
        migrations.RunPython(populate_retest_notes_history, reverse_code=reverse_code),
    ]
