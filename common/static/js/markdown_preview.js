/*
Add realtime previews of markdown inputs.

Elements with class amp-preview are populated with html generated by showdown.
Each such element has a matching input (textarea) where the user enters the
markdown to be previewed.
*/

const showdown = require('showdown')
showdown.setFlavor('original')
const converter = new showdown.Converter({ ghCodeBlocks: true })

function escapeSpecialChars (str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;')
    .replace(/_/g, '&#95;') // Used by showdown as alternative to *
}

function previewMarkdown (sourceId, targetId) {
  const markdown = document.getElementById(sourceId).value
  const escapedText = escapeSpecialChars(markdown)
  const targetElement = document.getElementById(targetId)
  targetElement.innerHTML = converter.makeHtml(escapedText)
}

const previewElements = document.getElementsByClassName('amp-preview')

Array.from(previewElements).forEach(function (previewElement) {
  const previewId = previewElement.id
  const inputId = previewId.replace('preview-', '')
  const inputElement = document.getElementById(inputId)
  inputElement.oninput = function () {
    previewMarkdown(inputId, previewId)
  }
  previewMarkdown(inputId, previewId)
})

module.exports = {
  escapeSpecialChars,
  previewMarkdown
}
