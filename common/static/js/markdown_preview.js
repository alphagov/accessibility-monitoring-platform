/*
Add realtime previews of markdown inputs.

Elements with class amp-preview are populated with html generated by showdown.
Each such element has a matching input (textarea) where the user enters the
markdown to be previewed.
*/

const showdown = require('showdown')
showdown.setFlavor('original')
const converter = new showdown.Converter({
  ghCodeBlocks: true,
  smoothLivePreview: true,
  simpleLineBreaks: false,
  literalMidWordUnderscores: true,
  ghCompatibleHeaderId: false
})

function normalizeMarkdown(input) {
  const lines = input.split('\n');
  const output = [];

  for (let i = 0; i < lines.length; i++) {
    const current = lines[i]
    const next = lines[i+1] || ''
    const isListItem = /^(\d+\.|[-*+])\s+/.test(current);
    const nextIsListItem = /^(\d+\.|[-*+])\s+/.test(next);

    output.push(current);
    if (!(isListItem === false && nextIsListItem === true)) {
      output.push('\n');
    }
  }
  return output.join('')
}

function escapeSpecialChars (str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;')
    .replace(/_/g, '&#95;') // Used by showdown as alternative to *
}

function undoubleEscape (str) {
  return str
    .replace(/&amp;amp;/g, '&amp;')
    .replace(/&amp;lt;/g, '&lt;')
    .replace(/&amp;gt;/g, '&gt;')
    .replace(/&amp;quot;/g, '&quot;')
    .replace(/&amp;apos;/g, '&apos;')
    .replace(/&amp;#95;/g, '&#95;')
}

function previewMarkdown (sourceId, targetId) {
  const markdown = document.getElementById(sourceId).value
  const normalized = normalizeMarkdown(markdown)
  const escapedText = escapeSpecialChars(normalized)
  const targetElement = document.getElementById(targetId)
  targetElement.innerHTML = undoubleEscape(converter.makeHtml(escapedText))
}

const previewElements = document.getElementsByClassName('amp-preview')

Array.from(previewElements).forEach(function (previewElement) {
  const previewId = previewElement.id
  const inputId = previewId.replace('preview-', '')
  const inputElement = document.getElementById(inputId)
  inputElement.oninput = function () {
    previewMarkdown(inputId, previewId)
  }
  previewMarkdown(inputId, previewId)
})

module.exports = {
  escapeSpecialChars,
  undoubleEscape,
  previewMarkdown
}
